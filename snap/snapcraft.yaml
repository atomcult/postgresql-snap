name: postgresql
base: core24
adopt-info: postgresql
summary: PostgreSQL is a powerful, open source object-relational database system.
description: |
  PostgreSQL is a powerful, open source object-relational database system.
  It has more than 15 years of active development and a proven architecture
  that has earned it a strong reputation for reliability, data integrity,
  and correctness.

assumes: [snapd2.45]
confinement: strict
grade: stable

system-usernames:
  snap_daemon: shared

plugs:
  shared-memory:
    private: true

hooks:
  install:
    environment:
      PGPASS: "changeme"

apps:
  daemon:
    daemon: forking
    install-mode: disable
    command-chain: [ bin/snapcraft-preload ]
    command: usr/bin/pg-pg_ctl start
    environment:
      SNAPCRAFT_PRELOAD_REDIRECT_ONLY_SHM: "1"
    plugs:
      - network
      - network-bind
      - shared-memory

  psql:
    command: usr/bin/pg-psql
    plugs: 
      - network

parts:
  postgresql:
    plugin: nil
    override-build: |
      craftctl set version="$(
        apt-show-versions -a postgresql-16 |
          head -n -1                       |
          tail -1                          |
          cut -f2 -d' '
      )"
    build-packages:
      - apt-show-versions
    stage-packages:
      - postgresql-16
      - postgresql-contrib
    stage:
      - -usr/share/doc
      - -usr/share/man

  locales:
    plugin: nil
    stage-packages:
      - libc-bin
      - locales
    stage:
      - usr/bin/localedef
      - usr/lib/locale
      - usr/share/i18n

  setpriv:
    plugin: nil
    stage-packages:
      - util-linux
    stage:
      - usr/bin/setpriv

  scripts:
    plugin: dump
    source: scripts
    organize:
      '*': usr/bin/

  snapcraft-preload:
    source: https://github.com/sergiusens/snapcraft-preload.git
    plugin: cmake
    build-packages:
      - to arm64:
        - g++-arm-linux-gnueabihf
        - gcc-arm-linux-gnueabihf
      - else:
        - gcc-multilib
        - g++-multilib
    stage-packages:
      - to amd64:
        - lib32stdc++6 
    override-build: |
      cd $CRAFT_PART_SRC 
      cmake -DCMAKE_INSTALL_PREFIX=$CRAFT_PART_INSTALL/ .
      make install
      find "${CRAFT_PART_INSTALL}" -name '*.so' -exec strip {} \;
